= Red Hat Advanced Developer Suite with Jenkins — Promote to Production
:icons: font
:source-highlighter: rouge
:toc: macro
:toclevels: 1

toc::[]

== Part 1 — Set the Stage

_ACME needs safe, fast production deployments using Jenkins. RHADS turns risky manual releases into confident automated workflows while preserving Jenkins investments._

**Business Value**
* Production deployment time: 2–3 weeks → ~30 minutes
* Preserve existing Jenkins infrastructure and expertise
* No manual security reviews or handoffs
* Automatic SOC 2 and PCI audit evidence

**What this demo shows**
* ADS + Enterprise Contract (EC) + Artifact Signer + GitOps with Argo CD
* Shared Jenkins library: `RHTAP_Jenkins@main`
* Trigger model:
  * Git tag push → **staging** (uses `stage` overlay)
  * GitLab **Release** → **production** (uses `prod` overlay)

== Part 2 — Promote to Production with a GitLab Release

=== Know
* A GitLab Release triggers the Jenkins pipeline in *production* mode.
* The same Jenkinsfile handles both staging and production by inspecting the event type.
* Production promotion follows four major steps: gather images, verify with EC, tag for prod, deploy via GitOps.

=== Show
. Open `{gitlab_url}/development/my-quarkus-jnk` and sign in:  
  [subs=attributes+]
  ----
  Username: {gitlab_user}
  Password: {gitlab_user_password}
  ----
  image::jenkins-prod-1.png[]
. Go to *Deploy > Releases*.  
  image::jenkins-prod-2.png[]
. Click *Create a new release*, choose an existing tag (e.g., `v1.0`), optionally add notes, then click *Create release*.  
  image::jenkins-prod-3.png[]
. In Developer Hub, open *Catalog →* component **my-quarkus-jnk**.  
  image::jenkins-prod-7.png[]
. Open the *CI* tab, find **promote-to-prod**, click *View build*, then *Open Blue Ocean* to view stages.  
  image::jenkins-prod-4.png[]  
  image::jenkins-prod-5.png[]

== Part 3 — Pipeline Tasks (Production Promotion)

* **Gather images (traceability)**  
  **Know**  
  * Determines which image is being promoted and records its source revision for audits.  
  **Show**  
  * Reads the release tag via GitLab API, resolves the validated staging image, writes `images.json`.  
  +
  [source,json,subs="attributes"]
  ----
  {
    "components": [
      {
        "containerImage": "quay.tssc-quay/tssc/my-quarkus-jnk:v1.0",
        "source": {
          "git": {
            "url": "{gitlab_url}/development/my-quarkus-jnk",
            "revision": "v1.0"
          }
        }
      }
    ]
  }
  ----

* **Verify with Enterprise Contract (security/policy gate)**  
  **Know**  
  * Ensures image is signed, has SBOM/provenance, passes CVE checks, complies with org policy.  
  **Show**  
  +
  [source,bash]
  ----
  cosign initialize \
    --mirror https://tuf.tssc-tas.dev \
    --root https://tuf.tssc-tas.dev/root.json

  ec validate image \
    --image quay.tssc-quay/tssc/my-quarkus-jnk:v1.0 \
    --policy default \
    --public-key k8s://openshift/trusted-keys \
    --output json
  ----
  +
  [source,json]
  ----
  {
    "successes": [
      "Image is signed and verified with cosign",
      "SBOM (CycloneDX) is present",
      "Provenance matches repository",
      "No critical vulnerabilities found"
    ],
    "failures": []
  }
  ----

* **Tag image for production (immutability + clarity)**  
  **Know**  
  * Marks validated image as production-approved without rebuilding.  
  **Show**  
  +
  [source,bash]
  ----
  skopeo copy \
    docker://quay.tssc-quay/tssc/my-quarkus-jnk:v1.0 \
    docker://quay.tssc-quay/tssc/my-quarkus-jnk:prod-v1.0
  ----

* **Deploy to production via GitOps (safe + traceable)**  
  **Know**  
  * Updates prod overlay so Argo CD syncs automatically.  
  **Show**  
  +
  [source,yaml]
  ----
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: my-quarkus-jnk
  spec:
    template:
      spec:
        containers:
          - name: my-quarkus-jnk
            image: quay.tssc-quay/tssc/my-quarkus-jnk:prod-v1.0
  ----
  +
  [source,diff]
  ----
  -          image: quay.io/redhat-appstudio/rhtap-task-runner:latest
  +          image: quay.tssc-quay/tssc/my-quarkus-jnk:prod-v1.0
  ----

== Part 4 — Summary

**You demonstrated**
* Production releases in ~30 minutes with full policy enforcement
* Jenkins enhanced — not replaced
* All changes signed, verified, traceable via GitOps
* Consistent, low-risk releases using one pipeline pattern
