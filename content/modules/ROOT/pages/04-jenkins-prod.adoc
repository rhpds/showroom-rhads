= Advanced Developer Suite Demo Narrative
Red Hat Advanced Developer Suite with Enterprise Contract and GitOps Promotion using Jenkins
:icons: font
:sectnums:
:source-highlighter: rouge

== Overview

Welcome! I’m excited to walk you through a demo showing how Red Hat’s Advanced Developer Suite (TAP), Enterprise Contract, and Argo CD work together to securely promote container images from staging to production using Jenkins.

We’ll explore a single Jenkins pipeline triggered by both Git tag pushes and GitLab releases, with policy enforcement and GitOps automation to ensure only compliant images reach production.

[NOTE]
====
The code snippets I’ll show are simplified for demo clarity. The actual pipeline has more details tailored to your environment.
====

== Pipeline Flow

Let’s start with how the pipeline is triggered.

[cols="1,1,1,1",options="header"]
|===
|Trigger Type | Triggered By | Target Environment | GitOps Overlay

| Tag push
| `git push tag v1.2.3`
| Staging
| `overlays/stage/`

| GitLab Release (via UI)
| GitLab UI “Create Release from Tag”
| Production
| `overlays/prod/`
|===

For this demo, I’ll first simulate pushing a Git tag to trigger staging. Later, I’ll show you how creating a GitLab Release promotes the image to production.

== 2. GitLab Release – Promote to Production

When a developer is ready to promote an image to production, they create a GitLab Release from the existing tag.

Here’s the quick process:

. Navigate to the repository in GitLab
. Go to *Deploy > Releases*
. Click *New Release*
. Select the existing tag (e.g., `v1.2.3`)
. Add release notes if desired, then click *Create release*

This triggers a webhook which starts the same Jenkins pipeline—but this time, it detects a release event and switches into **production promotion mode**. Navigate to the *my-quarkus-jnk* component in **Developer Hub**. Then:

. Select the `my-quarkus-jnk` component
. Switch to the **CI** tab to view pipeline runs
. Identfiy the current build labeled **promote-to-prod** and click on **View build** to open Jenkins and click `Open Blue Ocean` to walk through the key stages of the Jenkins pipeline:

== Pipeline Tasks

As the Jenkins pipeline runs, guide the audience through each of the following tasks. Each task demonstrates a critical part of the secure software supply chain.

=== Task 1.1 `extract-destination-image-tag` - Extract Gitlab tag value

Inside the Jenkins pipeline, in the `gather-images` stage, we run a script that extracts the release tag from GitLab using its API. This tag lets us build the correct image URL for promotion.

== Task 1.2  `gather-images-to-verify` – Generate `images.yaml`

Next, in the same `gather-images` stage, the pipeline generates an `images.yaml` file. This file points to the container image tagged during the staging deployment, using the GitLab tag value.

Here’s an example of what that looks like:

.Example `images.json`
[source,json]
----
{
  "components": [
    {
      "containerImage": "quay.tssc-quay/tssc/my-quarkus-jnk:v1.2.3",
      "source": {
        "git": {
          "url": "{gitlab_url}/org/my-quarkus-jnk",
          "revision": "v1.2.3"
        }
      }
    }
  ]
}
----

This `images.yaml` is used as input to the Enterprise Contract validation step.

== Task 2 `verify-enterprise-contract` – Validate Image and Metadata

This is a critical gate. Before promotion, we validate the image with Enterprise Contract, checking:

- Cosign signature verification
- Presence of SBOM
- SLSA provenance
- No high or critical CVEs
- Compliance with org policies

In Jenkins, the `verify-ec` stage runs this using the `rhtap.verify_enterprise_contract()` step.

First, we initialize Cosign’s trust root:

[source,bash]
----
cosign initialize \
  --mirror https://tuf.tssc-tas.dev \
  --root https://tuf.tssc-tas.dev/root.json
----

Then we run the actual validation:

[source,bash]
----
ec validate image \
  --image quay.tssc-quay/tssc/my-quarkus-jnk:v1.2.3 \
  --policy default
