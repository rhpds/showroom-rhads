= Advanced Developer Suite Demo Instructions
Red Hat Advanced Developer Suite with Enterprise Contract and Artifact Signer
:icons: font
:sectnums:
:source-highlighter: rouge
:toc: macro
:toclevels: 1

toc::[]

== Overview

This module extends the RHADS demo by showing how the Advanced Developer Suite enables secure promotion of container images using GitOps, Enterprise Contract, and Argo CD — all built on top of OpenShift Pipelines.

In this scenario, we simulate a platform team at *acme* tagging a new release in Git. That simple action triggers a series of automated steps:

* Validates the container image using Enterprise Contract policies
* Tags the verified image with the release version (e.g., `v1.0.0`)
* Promotes the image to the `prod` environment via GitOps
* Argo CD detects and applies the change, deploying the updated version to production

This module demonstrates how *acme* achieves secure, traceable, and automated release workflows using open standards like SLSA and GitOps principles.

[NOTE]
====
The examples and commands in this guide are representative of the *acme* demo environment. Replace with actual repository URLs, credentials, or config as needed in your setup.
====


== Pipeline Flow

To demonstrate how *acme* securely promotes builds to production, explain to your audience that the pipeline is triggered by creating a release from an existing Git tag in GitLab.

To show this:

. Open your GitLab repository: {gitlab_url}/development/my-quarkus-tkn[my-quarkus-tkn^]
  Use username `{gitlab_user}` and password `{gitlab_user_password}`
+
image::tekton-stage-1.png[]
. Navigate to *Deploy > Releases > Create a new release*
+
image::tekton-stage-2.png[]
. Select an existing tag (e.g., `v1.2.3`) or create a new one
. Optionally, enter release notes
. Click *Create release*
+
image::tekton-stage-3.png[]

Tell your audience:
“This release event kicks off the OpenShift Pipelines pipeline via a GitLab webhook. After validating the image, it automatically promotes it to the `prod` environment.”

After creating the release, switch to the Developer Hub:

. Go to the `my-quarkus-tkn` component in *Developer Hub*
. Click the **CI** tab
. Look for a pipeline run labeled **promote-to-prod** and expand it to view details
+
image::tekton-stage-3.png[]

Use this view to walk through each step of the promotion pipeline — from validation to tagging to GitOps update — showing how *acme* automates trusted delivery to production.

== Pipeline Tasks

As the OpenShift Pipelines pipeline runs, guide your audience through each task. These steps demonstrate how *acme* enforces trust and security before promoting anything to production.

=== Task 1.1: `extract-destination-image-tag`

This task captures the Git tag from the release event and makes it available to subsequent tasks.

Explain:
“This step ensures the pipeline knows which image version is associated with the release. The tag (e.g., `v1.2.3`) becomes the reference point for all future validations and promotions.”

=== Task 1.2: `gather-images-to-verify`

This task maps the Git release to the image produced during staging. It uses the tag to locate the previously built container image and creates a metadata file named `images.json`.

Tell the audience:
“We’re not building a new image here — we’re promoting an already built and verified one. The `images.json` tells us exactly what image we’re promoting and where it came from.”

.Show sample `images.json`
[source,json,subs="attributes"]
----
{
  "components": [
    {
      "containerImage": "quay.tssc-quay/tssc/my-quarkus-jnk:v1.2.3",
      "source": {
        "git": {
          "url": "{gitlab_url}/development/my-quarkus-jnk",
          "revision": "v1.2.3"
        }
      }
    }
  ]
}
----

Emphasize:
“This metadata ensures traceability — it links the image back to its source code and verifies it hasn't been tampered with.”


=== Task 2: `verify-enterprise-contract`

Let your audience know this is where supply chain security checks occur.

Step 1: The pipeline initializes trust via Cosign:

[source,bash]
----
cosign initialize \
  --mirror http://tuf.tssc-tas.svc \
  --root http://tuf.tssc-tas.svc/root.json
----

Step 2: Enterprise Contract validates the image:

[source,bash]
----
ec validate image \
  --image quay.tssc-quay/tssc/my-quarkus-tkn:v1.2.3 \
  --policy git::github.com/org/ec-policies//default \
  --public-key k8s://openshift/trusted-keys \
  --output json
----

Describe the validations performed:

* Digital signature with Cosign
* SBOM presence (e.g., SPDX, CycloneDX)
* Provenance metadata (how the image was built)
* CVE scanning
* Organizational policy compliance

[NOTE]
====
*Enterprise Contract (EC)* validates that container images meet your organization's security and compliance policies before promotion.

*TUF (The Update Framework)* protects signing metadata and ensures it hasn’t been tampered with.

*SBOM (Software Bill of Materials)* is a dependency list used to scan for known vulnerabilities.

*Provenance* proves how and where the image was built — establishing a trusted build process.
====

Tip: You can simulate a failed validation (e.g., by modifying the EC policy or image) to demonstrate that the pipeline halts if verification fails.


=== Task 3: `copy-image`

“Now that our image has passed all security checks, let’s promote it to production by tagging it with a release label.”

[source,bash]
----
skopeo copy \
  docker://quay.tssc-quay/tssc/my-quarkus-tkn:v1.2.3 \
  docker://quay.tssc-quay/tssc/my-quarkus-tkn:prod-v1.2.3
----

==== Explain

This command promotes the previously validated image by creating a new tag prefixed with `prod-`.

* This tag (`prod-v1.2.3`) clearly identifies the image as production-ready.
* It ensures traceability — we know which exact source and validation steps led to this image.
* Only images that pass EC validation make it this far, preventing unsafe code from being deployed.
* Argo CD will watch for this tag and deploy it to the production environment.


=== Task 4: `update-deployment`

“Next, let’s update the GitOps repo so Argo CD knows to deploy the newly promoted image.”

The pipeline updates the following file:

[source,yaml]
----
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-quarkus-tkn
spec:
  template:
    spec:
      containers:
        - name: my-quarkus-tkn
          image: quay.tssc-quay/tssc/my-quarkus-tkn:prod-v1.2.3
----

This file lives at:

`overlays/prod/deployment-patch.yaml`

The patch is picked up by this `kustomization.yaml`:

[source,yaml]
----
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ../../base
patchesStrategicMerge:
  - deployment-patch.yaml
----

==== Explain

* This patch updates the container image reference in the production overlay.
* Openshift Pipelines commits and pushes this patch to the GitOps repository.
* Argo CD is watching this repo — as soon as it detects the change, it syncs the deployment to the `prod` cluster.
* This ensures that only verified, tagged images are deployed, and the entire process is fully auditable.


== Wrap-Up

=== Summary of Tasks

|===
| Task | Description

| Git Release
| Triggered via GitLab Release from Tag

| 1.1 extract-destination-image-tag
| Extracts the Git tag attached to the release to be used as part of the destination image tag

| 1.2 gather-images-to-verify
| Resolves tag to commit and generates `images.json` pointing to the image to be validated

| 2 verify-enterprise-contract
| Validates signature, SBOM, provenance, CVEs, and organizational policy using Enterprise Contract

| 3 copy-image
| Copies the previously staged image and tags it as `prod-v1.2.3`

| 4 update-deployment
| Updates `overlays/prod` in the GitOps repo, which triggers an Argo CD deployment
|===

=== Key Takeaways

* Creating a release from a Git tag triggers the secure promotion pipeline.
* Enterprise Contract ensures only compliant, trusted images are promoted.
* Tasks and pipelines are reusable, scalable, and consistent across teams.
* GitOps overlays manage environment-specific configuration cleanly.
* Argo CD continuously ensures that the production cluster reflects the Git source of truth.


== Optional Enhancements

Use these if you want to go deeper during the demo:

* Simulate a failed validation
  - For example, promote an unsigned image to show Enterprise Contract blocking the release.

* Show image tags in Quay
  - Display both the `:v1.2.3` (staged) and `:prod-v1.2.3` (promoted) tags.

* Demo Argo CD UI
  - Show how Argo CD detects the Git change and syncs to the `prod` environment automatically.

* Display the Enterprise Contract policy bundle
  - Help the audience understand what rules are being enforced during validation.

* Mention stage promotion
  - Explain that promoting to `stage` works similarly using a different overlay and trigger mechanism.

