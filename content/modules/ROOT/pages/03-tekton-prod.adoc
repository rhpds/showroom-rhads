= Advanced Developer Suite Demo Instructions
Red Hat Advanced Developer Suite with Enterprise Contract and Artifact Signer
:icons: font
:sectnums:
:source-highlighter: rouge
:toc: macro
:toclevels: 1

toc::[]

== Overview

Know:: This module extends the RHADS demo by showing how the Advanced Developer Suite enables secure promotion of container images using GitOps, Enterprise Contract, and Argo CD — all built on top of OpenShift Pipelines.

In this scenario, a platform team at *acme* tagging a new release in Git is simulated. That simple action triggers a series of automated steps:

* Container image validation using Enterprise Contract policies is performed
* The verified image is tagged with the release version (e.g., `v1.0.0`)
* The image is promoted to the `prod` environment via GitOps
* Argo CD detects and applies the change, deploying the updated version to production

How *acme* achieves secure, traceable, and automated release workflows using open standards like SLSA and GitOps principles is demonstrated in this module.

[NOTE]
====
The examples and commands in this guide are representative of the *acme* demo environment. Actual repository URLs, credentials, or config should be replaced as needed in your setup.
====

== Pipeline Flow

Know:: How *acme* securely promotes builds to production is demonstrated by showing that the pipeline is triggered by creating a release from an existing Git tag in GitLab.

Do::
. Open your GitLab repository: {gitlab_url}/development/my-quarkus-tkn[my-quarkus-tkn^]
  Use username `{gitlab_user}` and password `{gitlab_user_password}`

image::tekton-prod-1.png[]

. Navigate to *Deploy > Releases > Create a new release*

image::tekton-prod-2.png[]

. Select an existing tag (e.g., `v1.0`) or create a new one

. Optionally, enter release notes

. Click *Create release*

image::tekton-prod-3.png[]

Know:: This release event kicks off the OpenShift Pipelines pipeline via a GitLab webhook. After the image is validated, it is automatically promoted to the `prod` environment.

After the release is created, a switch to the Developer Hub should be made:

Do::
. Go to the `my-quarkus-tkn` component in *Developer Hub*

. Click the **CI** tab

. Look for a pipeline run labeled **promote-to-prod** and expand it to view details

image::tekton-prod-4.png[]

Know:: This view should be used to walk through each step of the promotion pipeline — from validation to tagging to GitOps update — showing how *acme* automates trusted delivery to production.

== Pipeline Tasks

Know:: As the OpenShift Pipelines pipeline runs, each task should be reviewed with the audience. These steps demonstrate how *acme* enforces trust and security before anything is promoted to production.

=== Task 1.1: `extract-destination-image-tag`

Know:: The Git tag from the release event is captured by this task and made available to subsequent tasks.

This step ensures the pipeline knows which image version is associated with the release. The tag (e.g., `v1.0`) becomes the reference point for all future validations and promotions.

=== Task 1.2: `gather-images-to-verify`

Know:: The Git release is mapped to the image produced during staging by this task. The tag is used to locate the previously built container image and a metadata file named `images.json` is created.

A new image is not built here — an already built and verified one is being promoted. The `images.json` tells exactly what image is being promoted and where it came from.

.Sample `images.json` can be shown
[source,json,subs="attributes"]
----
{
  "components": [
    {
      "containerImage": "quay.tssc-quay/tssc/my-quarkus-jnk:v1.0",
      "source": {
        "git": {
          "url": "{gitlab_url}/development/my-quarkus-jnk",
          "revision": "v1.0"
        }
      }
    }
  ]
}
----

This metadata ensures traceability — the image is linked back to its source code and it is verified that it hasn't been tampered with.

=== Task 2: `verify-enterprise-contract`

Know:: Supply chain security checks occur at this point.

Step 1: Trust is initialized by the pipeline via Cosign:

[source,bash]
----
cosign initialize \
  --mirror http://tuf.tssc-tas.svc \
  --root http://tuf.tssc-tas.svc/root.json
----

Step 2: The image is validated by Enterprise Contract:

[source,bash]
----
ec validate image \
  --image quay.tssc-quay/tssc/my-quarkus-tkn:v1.0 \
  --policy git::github.com/org/ec-policies//default \
  --public-key k8s://openshift/trusted-keys \
  --output json
----

The following validations are performed:

* Digital signature with Cosign
* SBOM presence (e.g., SPDX, CycloneDX)
* Provenance metadata (how the image was built)
* CVE scanning
* Organizational policy compliance

[NOTE]
====
*Enterprise Contract (EC)* validates that container images meet your organization's security and compliance policies before promotion.

*TUF (The Update Framework)* protects signing metadata and ensures it hasn't been tampered with.

*SBOM (Software Bill of Materials)* is a dependency list used to scan for known vulnerabilities.

*Provenance* proves how and where the image was built — establishing a trusted build process.
====

A failed validation can be simulated (e.g., by modifying the EC policy or image) to demonstrate that the pipeline halts if verification fails.

=== Task 3: `copy-image`

Know:: Now that the image has passed all security checks, it is promoted to production by tagging it with a release label.

[source,bash]
----
skopeo copy \
  docker://quay.tssc-quay/tssc/my-quarkus-tkn:v1.0 \
  docker://quay.tssc-quay/tssc/my-quarkus-tkn:prod-v1.0
----

The previously validated image is promoted by this command by creating a new tag prefixed with `prod-`.

* This tag (`prod-v1.0`) clearly identifies the image as production-ready.
* Traceability is ensured — the exact source and validation steps that led to this image are known.
* Only images that pass EC validation make it this far, preventing unsafe code from being deployed.
* Argo CD will watch for this tag and deploy it to the production environment.

=== Task 4: `update-deployment`

Know:: The GitOps repo is updated next so Argo CD knows to deploy the newly promoted image.

The following file is updated by the pipeline:

[source,yaml]
----
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-quarkus-tkn
spec:
  template:
    spec:
      containers:
        - name: my-quarkus-tkn
          image: quay.tssc-quay/tssc/my-quarkus-tkn:prod-v1.0
----

This file lives at:

`overlays/prod/deployment-patch.yaml`

The patch is picked up by this `kustomization.yaml`:

[source,yaml]
----
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ../../base
patchesStrategicMerge:
  - deployment-patch.yaml
----

* The container image reference in the production overlay is updated by this patch.
* This patch is committed and pushed to the GitOps repository by OpenShift Pipelines.
* Argo CD is watching this repo — as soon as the change is detected, the deployment is synced to the `prod` cluster.
* Only verified, tagged images are deployed by this process, and the entire process is fully auditable.

== Wrap-Up

=== Summary of Tasks

|===
| Task | Description

| Git Release
| Triggered via GitLab Release from Tag

| 1.1 extract-destination-image-tag
| Extracts the Git tag attached to the release to be used as part of the destination image tag

| 1.2 gather-images-to-verify
| Resolves tag to commit and generates `images.json` pointing to the image to be validated

| 2 verify-enterprise-contract
| Validates signature, SBOM, provenance, CVEs, and organizational policy using Enterprise Contract

| 3 copy-image
| Copies the previously staged image and tags it as `prod-v1.0`

| 4 update-deployment
| Updates `overlays/prod` in the GitOps repo, which triggers an Argo CD deployment
|===

=== Key Takeaways

Know::
* A secure promotion pipeline is triggered by creating a release from a Git tag.
* Only compliant, trusted images are promoted by Enterprise Contract validation.
* Tasks and pipelines are reusable, scalable, and consistent across teams.
* Environment-specific configuration is managed cleanly by GitOps overlays.
* The production cluster is continuously ensured by Argo CD to reflect the Git source of truth.

== Optional Enhancements

Know:: The following can be used if going deeper during the demo is desired:

* A failed validation can be simulated
  - For example, an unsigned image can be promoted to show Enterprise Contract blocking the release.

* Image tags in Quay can be shown
  - Both the `:v1.0` (staged) and `:prod-v1.0` (promoted) tags can be displayed.

* The Argo CD UI can be demonstrated
  - How Argo CD detects the Git change and syncs to the `prod` environment automatically can be shown.

* The Enterprise Contract policy bundle can be displayed
  - The rules being enforced during validation can be explained to help the audience understand.

* Stage promotion can be mentioned
  - How promoting to `stage` works similarly using a different overlay and trigger mechanism can be explained.

